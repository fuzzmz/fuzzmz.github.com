<!DOCTYPE html>
<html lang="en">
<head>
        <title>QWERTY - fast keystrokes - security</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href=".././theme/css/main.css" type="text/css" />
        
        <link href="http://feeds.feedburner.com/qwertyfuzz/main" type="application/atom+xml" rel="alternate" title="QWERTY - fast keystrokes Atom Feed" />
        
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
                <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->
<script type="text/javascript" src="./static/js/prototype.js"></script>
<script type="text/javascript" src="./static/js/scriptaculous.js?load=effects,builder"></script>
<script type="text/javascript" src="./static/js/lightbox.js"></script>
<link rel="stylesheet" href="./static/js/lightbox.css" type="text/css" media="screen" />
</head>

<body id="index" class="home">

        <header id="banner" class="body">
                <h1><a href="../.">QWERTY - fast keystrokes </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li ><a href=".././category/code.html">code</a></li>
                
                    <li ><a href=".././category/linux.html">linux</a></li>
                
                    <li ><a href=".././category/rand.html">rand</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                

            

        
        
            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href=".././2012/11/20/tfa-google-auth/">Two-factor auth with Google Authenticator</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2012-11-20T00:00:00">
                Tue 20 November 2012
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/serban-constantin.html">Serban Constantin</a>
        </address>
        
<p>In <a href=".././category/linux.html">linux</a>. </p>
<p>tags: <a href=".././tag/debian.html">Debian</a><a href=".././tag/google.html">Google</a><a href=".././tag/security.html">security</a><a href=".././tag/tfa.html">TFA</a><a href=".././tag/t-fa.html">T-FA</a><a href=".././tag/2fa.html">2FA</a></p>


<p>view: <a href="https://github.com/fuzzmz/fuzzmz.github.com/blob/sources/2012-11-20-tfa-google-auth.md">article source</a></p>
</footer><!-- /.post-info --><h2 id="the-reason">The reason</h2>
<p>As you may remember I've went through <a href="http://fuzz.me.uk/2012/01/19/locked-out/">a bit of an ordeal</a> trying to secure my server by allowing users to log in only with certificates. This had the advantage of being more secure than a password but, as time went on, the big disadvantage of not being able to log in from PCs which lacked the certs.</p>
<p>Moving forward (and doing a fresh install on the VPS, which I'll address in a future post) I've went back on my decision to only allow certificate based logins. The downside to this change is that I felt the the server was still exposed despite using a strong password.</p>
<p>Fortunately Google offers a nice Authenticator application for smartphones as well as offering a <a href="https://code.google.com/p/google-authenticator/">pluggable authentication module (PAM)</a> which ties in with the Authenticator app for two-factor authentication on login. This means that besides knowing the username and password someone would need to have a time-based one-time password generated by the app in order to log in to the site.</p>
<hr />
<h2 id="installing-google-authenticator-pam">Installing google-authenticator PAM</h2>
<p>I'm running Debian so this guide applies to Debian and Debian-based distributions.</p>
<p>First of all we're going to need to install the build-essential package which will allow us to actually install the software.</p>
<div class="codehilite"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span>
</pre></div>


<p>After we've got them installed we're going to install some dependencies needed for the PAM module to work (libpam-dev) as well as to retrieve (git) and easily configure the software (libqrencode-dev).</p>
<div class="codehilite"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">git</span> <span class="n">libpam</span><span class="o">-</span><span class="n">dev</span> <span class="n">libqrencode</span><span class="o">-</span><span class="n">dev</span> <span class="n">libpam0g</span><span class="o">-</span><span class="n">dev</span>
</pre></div>


<p>Now let's go ahead and download the code:</p>
<div class="codehilite"><pre><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">code</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">p</span><span class="o">/</span><span class="n">google</span><span class="o">-</span><span class="n">authenticator</span><span class="o">/</span>
</pre></div>


<p>This grabs the files from Google's server and creates a local copy. After that's done navigate to the google-authenticator/libpam directory and run</p>
<div class="codehilite"><pre><span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</pre></div>


<p>Now that we've got everything installed it's time to actually set up the application. This is extremely easy, just run <code>google-authenticator</code> which will generate a QR code (thanks to the libqrencode-dev package); scan this code in the Google Authenticator mobile app (or enter the information by hand) and head back to your PC to finish setting up the software by answering the questions it asks.</p>
<hr />
<h2 id="setting-up-the-os-to-use-challenge-response-authentication">Setting up the OS to use Challenge Response Authentication</h2>
<p>Once the previous step is done we need to let the OS know that is has to use the newly installed PAM module. To do this we need to edit the <code>/etc/pam.d/common-auth</code> (by running <code>sudo vim /etc/pam.d/common-auth</code> for example) and adding the following line:</p>
<div class="codehilite"><pre><span class="n">auth</span>    <span class="n">required</span>                        <span class="n">pam_google_authenticator</span><span class="p">.</span><span class="n">so</span>
</pre></div>


<p>Next up is the ssh_config file in order to allow SSH to send challenge requests:</p>
<div class="codehilite"><pre><span class="n">sudo</span> <span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd_config</span>
</pre></div>


<p>Find the line containing <code>ChallengeResponseAuthentication</code> and set it to yes (also uncomment it if it's commented out) so that it looks like:</p>
<div class="codehilite"><pre><span class="n">ChallengeResponseAuthentication</span> <span class="n">yes</span>
</pre></div>


<p>Now all there's left to do is restart the SSH server and to test the change:</p>
<div class="codehilite"><pre><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">ssh</span> <span class="n">restart</span>
</pre></div>


<p>The next time you'll log in you should be greeted with a message asking for a verification code after entering the username and password.</p>
<div class="codehilite"><pre>ssh user@host
Password:
Verification code:
</pre></div>


<hr />
<h2 id="bonus-points">Bonus points</h2>
<p>One advantage to this is the fact that even if you log in using a certificate (which bypasses the two-factor authentication) you are still asked for a verification code when trying to elevate to root via sudo for example.</p><p>There are <a href=".././2012/11/20/tfa-google-auth/#disqus_thread">comments</a>.</p>
                </article>
                
                    
<p class="paginator">
    
    Page 1 / 1
    
</p>

                
            </aside><!-- /#featured -->
            
        
        
        
            </ol><!-- /#posts-list -->
            
            </section><!-- /#content -->
        
    


        <section id="extras" class="body">
        
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28459915-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>



<script type="text/javascript">
    var disqus_shortname = 'qwertyfuzz';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>